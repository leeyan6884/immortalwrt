name: Build OpenWrt x86_64

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: â¬ Checkout
      uses: actions/checkout@v4

    - name: ðŸ•’ Set up timezone
      run: sudo timedatectl set-timezone "$TZ"

    - name: âš™ï¸ Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache ecj fastjar file clang cmake g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-venv python3-setuptools \
          python3-dev rsync unzip zlib1g-dev wget gperf zlib1g-dev gawk flex git subversion \
          wget curl libelf-dev libtool libtool-bin python3-pip libstdc++-12-dev

    - name: ðŸš€ Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt

        # æ›¿æ¢ feeds.conf.default
        cat > feeds.conf.default <<EOF
        src-git packages https://github.com/immortalwrt/packages
        src-git luci https://github.com/immortalwrt/luci
        src-git routing https://github.com/openwrt-routing/packages
        src-git telephony https://git.openwrt.org/feed/telephony.git
        src-git kenzo https://github.com/kenzok8/openwrt-packages
        src-git small https://github.com/kenzok8/small
        EOF

    - name: ðŸ”„ Update & install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: ðŸ”§ Load custom config
      working-directory: ./openwrt
      run: |
        curl -Lo .config https://raw.githubusercontent.com/${{ github.repository }}/main/.config
        make defconfig

    - name: ðŸ§± Compile firmware
      working-directory: ./openwrt
      run: |
        make download -j$(nproc) || make download -j1 V=s
        make -j$(nproc) V=s

    - name: ðŸ“¦ Pack firmware
      working-directory: ./openwrt
      run: |
        mkdir -p ../firmware
        cp -rf bin/targets/*/*/* ../firmware/

    - name: â˜ï¸ Upload firmware to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-x86_64
        path: firmware/

    - name: ðŸ“¤ Upload to GitHub Releases
      uses: ncipollo/release-action@v1
      with:
        tag: "firmware-${{ github.run_number }}"
        name: "OpenWrt x86_64 Build ${{ github.run_number }}"
        body: |
          è‡ªåŠ¨ç¼–è¯‘å›ºä»¶ï¼šx86_64 UEFI + BIOS åŒå¯  
          åŒ…å«æ’ä»¶ï¼šPasswallã€OpenClashã€MosDNSã€Dockerã€Argon ä¸»é¢˜  
          æž„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
        artifacts: "firmware/*"
